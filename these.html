<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" id="pwa-manifest">
    <title>EduScreen - Learning Difficulty Screening Tool</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --font-family: system-ui, -apple-system, sans-serif;
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        .dyslexia-font {
            --font-family: "Comic Sans MS", "Arial", sans-serif;
            letter-spacing: 0.1em;
            word-spacing: 0.2em;
            line-height: 1.6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: var(--transition);
            line-height: 1.5;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Banner */
        .disclaimer-banner {
            background-color: var(--warning);
            color: #fff;
            padding: 10px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: bold;
            border-radius: 0 0 8px 8px;
            margin-bottom: 20px;
        }

        /* Toggles */
        .controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        .btn-toggle:hover { border-color: var(--primary); }

        /* Cards & Sections */
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2, h3 { margin-bottom: 15px; color: var(--text-main); }
        p { margin-bottom: 15px; color: var(--text-muted); }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-family);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            transition: var(--transition);
        }
        .btn:hover { background: var(--primary-hover); }

        /* Assessment UI */
        .progress-container {
            width: 100%; background: var(--border-color);
            border-radius: 8px; height: 10px; margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%; background: var(--primary);
            width: 0%; transition: width 0.3s ease;
        }
        
        .question-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; }
        
        .options-grid { display: flex; flex-direction: column; gap: 10px; }
        .option-btn {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            color: var(--text-main);
            font-size: 1rem;
            font-family: var(--font-family);
            transition: var(--transition);
        }
        .option-btn:hover { border-color: var(--primary); background: var(--border-color); }
        .option-btn.selected { border-color: var(--primary); background: rgba(37, 99, 235, 0.1); }

        .msg-box {
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            background: rgba(37, 99, 235, 0.1); color: var(--primary);
            display: none; text-align: center; font-weight: bold;
        }

        /* Report UI */
        .chart-container { width: 100%; height: 300px; margin: 20px 0; position: relative; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .result-card {
            padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--bg-color);
        }
        .risk-badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-top: 5px; color: white;
        }
        .risk-none { background: var(--success); }
        .risk-mild { background: #3b82f6; }
        .risk-moderate { background: var(--warning); }
        .risk-strong { background: var(--danger); }

        .suggestion-list { list-style-position: inside; margin-bottom: 20px; color: var(--text-muted); }
        .suggestion-list li { margin-bottom: 5px; }

        @media print {
            .controls, .btn, .disclaimer-banner { display: none !important; }
            body { background: white; color: black; }
            .section { box-shadow: none; border: none; padding: 0; }
            .result-card { border: 1px solid #ccc; page-break-inside: avoid; }
        }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .section { padding: 20px; }
        }
    
    #splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #0f172a; 
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000; /* Sabse upar rahega */
    transition: opacity 0.8s ease, visibility 0.8s;
}

.splash-container {
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* Isse names niche hi rahenge */
    align-items: center;
    height: 80%; /* Screen ka 80% area use karega */
    width: 100%;
    text-align: center;
}

/* Middle Section */
.splash-main {
    margin-top: auto; /* Push content to vertical center */
    margin-bottom: auto;
    animation: fadeInScale 1.5s ease-out;
}

.splash-title {
    font-size: clamp(3rem, 10vw, 5rem); /* Mobile responsive font */
    font-weight: 900;
    margin: 0;
    background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 6px;
    line-height: 1.1;
}

.splash-subtitle {
    font-size: 1.5rem;
    color: #f1f5f9;
    margin-top: 15px;
    letter-spacing: 10px;
    text-transform: lowercase;
    opacity: 0.9;
}

/* Bottom Section */
.creators-section {
    margin-bottom: 20px;
    padding: 20px;
    animation: fadeInUp 1s ease-out 0.5s both; /* Thoda late aayega */
}

.developed-by {
    color: #94a3b8;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 8px;
}

.names-row {
    display: flex;
    gap: 20px;
    justify-content: center;
    flex-wrap: wrap; /* Mobile par names niche aa jayenge */
}

.names-row span {
    color: #bf953f;
    font-weight: 600;
    font-size: 1rem;
    border-bottom: 1px solid rgba(191, 149, 63, 0.3);
}

/* Animations */
@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.splash-hidden {
    opacity: 0;
    visibility: hidden;
}

    
    </style>
</head>
<body>
    <div id="splash-screen">
    <div class="splash-container">
        <div class="splash-main">
            <h1 class="splash-title">JNV SARAN</h1>
            <p class="splash-subtitle"> <i> presents </i> </p>
        </div>

        <div class="creators-section">
            <p class="developed-by">Developed by:</p>
            <div class="names-row">
                <span>Aryan</span>
                <span>Sagar</span>
                <span>Pranay</span>
                <span>Vikash</span>
                <span>Ujjwal</span>
            </div>
        </div>
    </div>
</div>

    
    <div class="disclaimer-banner">
        ‚ö†Ô∏è IMPORTANT: This is an early screening tool, NOT a diagnostic instrument. No medical advice is provided. No data is stored or transmitted. Please consult qualified educational or medical professionals for formal diagnosis.
    </div>

    <div class="container">
        <div class="controls">
            <button class="btn-toggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
            <button class="btn-toggle" onclick="toggleDyslexiaFont()">üìñ Dyslexia Font</button>
        </div>

        <div id="setup-section" class="section active">
            <h1>EduScreen Assessment</h1>
            <p>A professional screening tool to identify potential learning, attention, and cognitive profiles.</p>
            
            <div class="form-group">
                <label>Student Name (Local only, not saved):</label>
                <input type="text" id="student-name" placeholder="Enter name">
            </div>
            <div class="form-group">
                <label>Age:</label>
                <input type="number" id="student-age" placeholder="Enter age (e.g. 10)" min="5" max="18">
            </div>
            <div class="form-group">
                <label>Assessment Mode:</label>
                <select id="assessment-mode">
                    <option value="student">Student Self-Report (I am the student)</option>
                    <option value="teacher">Teacher/Parent Observation (Observing the student)</option>
                </select>
            </div>
            <button class="btn" onclick="startAssessment()">Start Screening</button>
        </div>

        <div id="assessment-section" class="section">
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <p id="progress-text" style="text-align: right; font-size: 0.9rem;"></p>
            
            <div id="encouragement-msg" class="msg-box">You're doing great! Keep going.</div>

            <h2 class="question-text" id="question-text">Question text here</h2>
            
            <div class="options-grid" id="options-grid">
                </div>
            
            <br>
            <button class="btn" id="next-btn" onclick="nextQuestion()" disabled>Next Question</button>
        </div>

        <div id="report-section" class="section">
            <h1>Assessment Report</h1>
            <p><strong>Student:</strong> <span id="rep-name"></span> | <strong>Age:</strong> <span id="rep-age"></span> | <strong>Date:</strong> <span id="rep-date"></span></p>
            <p><strong>Mode:</strong> <span id="rep-mode"></span></p>
            <hr style="border: 1px solid var(--border-color); margin: 20px 0;">

            <h3>Score Profile</h3>
            <div class="chart-container">
                <canvas id="resultsChart"></canvas>
            </div>

            <h3>Category Analysis</h3>
            <div class="result-grid" id="result-grid">
                </div>

            <h3>Identified Strengths</h3>
            <ul class="suggestion-list" id="strengths-list"></ul>

            <h3>Personalized Recommendations</h3>
            <ul class="suggestion-list" id="recommendations-list"></ul>

            <div style="background: var(--bg-color); padding: 15px; border-left: 4px solid var(--warning); margin: 20px 0;">
                <strong>Professional Recommendation:</strong>
                <p id="professional-note" style="margin-bottom: 0;"></p>
            </div>

            <button class="btn" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
            <br><br>
            <button class="btn" style="background: var(--text-muted);" onclick="location.reload()">Reset Assessment</button>
        </div>
    </div>

    <script>
    
    // Splash Screen Timeout Logic
window.addEventListener('DOMContentLoaded', () => {
    const splash = document.getElementById('splash-screen');
    
    // 3 second tak splash dikhega, fir gayab ho jayega
    setTimeout(() => {
        splash.classList.add('splash-hidden');
    }, 3000); 
});

    
        // --- DATA: Categories & Questions (80 Questions) ---
        const categories = {
            dyslexia: { name: "Dyslexia Indicators", desc: "Reading, spelling, and decoding." },
            dyscalculia: { name: "Dyscalculia Indicators", desc: "Number sense and arithmetic." },
            dysgraphia: { name: "Dysgraphia Indicators", desc: "Handwriting and written expression." },
            attention: { name: "Attention Difficulty", desc: "Focus and distractibility." },
            executive: { name: "Executive Function", desc: "Planning, organizing, and task management." },
            processing: { name: "Processing Speed", desc: "Pace of completing cognitive tasks." },
            working_memory: { name: "Working Memory", desc: "Holding and manipulating information." },
            recall: { name: "Recall Difficulty", desc: "Retrieving facts from long-term memory." },
            learning_anxiety: { name: "Learning Anxiety", desc: "Stress related to schoolwork." },
            test_anxiety: { name: "Test Anxiety", desc: "Stress specifically during evaluations." },
            motivation: { name: "Motivation", desc: "Drive to engage in academic tasks." },
            sensory: { name: "Sensory Sensitivity", desc: "Reactions to noise, light, or touch." },
            fine_motor: { name: "Fine Motor", desc: "Small muscle control (e.g., using scissors/pens)." },
            social: { name: "Social Learning", desc: "Interpreting social cues and interactions." },
            communication: { name: "Communication", desc: "Expressing thoughts verbally." }
        };

        const optionsTemplate = [
            { text: "Never / Rarely", val: 0 },
            { text: "Sometimes", val: 1 },
            { text: "Often", val: 2 },
            { text: "Almost Always", val: 3 }
        ];

        // Base 15 categories * 5 questions = 75 questions + 5 adaptive/general = 80 total
        // Generating structure programmatically to keep code clean but fulfill requirements.
        const questionDataRaw = [
            // Dyslexia
            ["dyslexia", "I mix up letters like 'b' and 'd' or 'p' and 'q'.", "Confuses similar letters (b/d, p/q)."],
            ["dyslexia", "Reading aloud makes me nervous or I stumble on words.", "Hesitates or struggles when reading aloud."],
            ["dyslexia", "Words seem to move around on the page.", "Complains of visual distortion when reading."],
            ["dyslexia", "I have trouble remembering how to spell common words.", "Inconsistent spelling of common sight words."],
            ["dyslexia", "It takes me a long time to finish a reading assignment.", "Reads significantly slower than peers."],
            // Dyscalculia
            ["dyscalculia", "I rely on my fingers to do simple math.", "Relies heavily on finger-counting for basic math."],
            ["dyscalculia", "I have trouble telling time on an analog clock.", "Struggles reading analog clocks."],
            ["dyscalculia", "I mix up math symbols like + and -.", "Confuses operation symbols (+, -, x)."],
            ["dyscalculia", "I find it hard to estimate costs when shopping.", "Difficulty estimating quantities or money."],
            ["dyscalculia", "I struggle to remember multiplication tables.", "Inability to memorize math facts."],
            // Dysgraphia
            ["dysgraphia", "My hand hurts when I write for a few minutes.", "Complains of hand fatigue while writing."],
            ["dysgraphia", "My handwriting is very messy and hard to read.", "Illegible handwriting, poor spatial planning."],
            ["dysgraphia", "I mix uppercase and lowercase letters randomly.", "Mixes upper/lower case letters inappropriately."],
            ["dysgraphia", "It's much easier for me to type than to handwrite.", "Significant discrepancy between typed and written work."],
            ["dysgraphia", "I struggle to get my thoughts out onto paper.", "Difficulty translating verbal ideas into written text."],
            // Attention
            ["attention", "I zone out when the teacher is talking.", "Frequently daydreams or loses focus during instruction."],
            ["attention", "Every little noise distracts me.", "Easily distracted by extraneous stimuli."],
            ["attention", "I make careless mistakes in my work.", "Makes careless errors in schoolwork."],
            ["attention", "I have trouble sitting still in my chair.", "Fidgets or struggles to remain seated."],
            ["attention", "I interrupt others before they finish speaking.", "Blurts out answers or interrupts."],
            // Executive Function
            ["executive", "I often lose my homework or school supplies.", "Frequently misplaces materials necessary for tasks."],
            ["executive", "I wait until the last minute to start big projects.", "Procrastinates significantly on long-term assignments."],
            ["executive", "My backpack and desk are extremely messy.", "Poor physical organization (messy desk/bag)."],
            ["executive", "I don't know how to break big tasks into smaller steps.", "Overwhelmed by multi-step projects."],
            ["executive", "I struggle to switch from recess back to classwork.", "Difficulty transitioning between activities."],
            // Processing Speed
            ["processing", "I'm always the last one to finish classroom assignments.", "Consistently the last to complete in-class work."],
            ["processing", "I need people to repeat instructions slowly.", "Requires instructions to be repeated or slowed down."],
            ["processing", "I feel overwhelmed when a lot of information comes at once.", "Overwhelmed by rapid verbal information."],
            ["processing", "It takes me a long time to copy notes from the board.", "Slow at copying from the board."],
            ["processing", "I freeze up when asked a question unexpectedly.", "Delayed response time when called upon."],
            // Working Memory
            ["working_memory", "I forget the first part of an instruction by the time I hear the end.", "Forgets multi-step instructions."],
            ["working_memory", "I lose track of what I was saying mid-sentence.", "Loses train of thought frequently."],
            ["working_memory", "I struggle to do mental math.", "Difficulty holding numbers in head for mental math."],
            ["working_memory", "I read a whole page and realize I remember nothing.", "Poor reading comprehension due to memory."],
            ["working_memory", "I have to reread sentences multiple times to understand.", "Rereads text frequently to retain meaning."],
            // Recall
            ["recall", "I study hard but forget everything the next day.", "Poor retention of studied material."],
            ["recall", "I know the answer but can't find the right word (it's on the tip of my tongue).", "Frequent word-retrieval difficulties."],
            ["recall", "I have trouble remembering names of people or places.", "Struggles with rote memorization of names/dates."],
            ["recall", "I perform much worse on fill-in-the-blank tests than multiple choice.", "Relies heavily on recognition over recall."],
            ["recall", "I forget routines I have done many times before.", "Forgets established daily routines."],
            // Learning Anxiety
            ["learning_anxiety", "I feel sick to my stomach before school.", "Exhibits somatic symptoms (stomachaches) before school."],
            ["learning_anxiety", "I cry or get very upset when homework is hard.", "Extreme emotional reaction to difficult tasks."],
            ["learning_anxiety", "I call myself 'stupid' when I make a mistake.", "Negative self-talk regarding intelligence."],
            ["learning_anxiety", "I try to avoid going to school or certain classes.", "School avoidance behaviors."],
            ["learning_anxiety", "I worry excessively about what the teacher thinks of my work.", "Overly concerned with teacher approval."],
            // Test Anxiety
            ["test_anxiety", "My mind goes blank as soon as a test starts.", "Freezes during assessments despite preparation."],
            ["test_anxiety", "My heart races when the teacher hands out a quiz.", "Physical signs of panic during testing."],
            ["test_anxiety", "I rush through tests just to get them over with.", "Rushes through assessments to escape anxiety."],
            ["test_anxiety", "I obsess over my grades after a test.", "Excessive worry about academic performance."],
            ["test_anxiety", "I sleep poorly the night before an exam.", "Sleep disruption prior to testing."],
            // Motivation
            ["motivation", "I don't see the point in doing homework.", "Expresses apathy towards academic work."],
            ["motivation", "I give up easily if I don't get it right the first time.", "Low frustration tolerance; gives up quickly."],
            ["motivation", "I only do the bare minimum to get by.", "Exhibits minimal effort on assignments."],
            ["motivation", "I need constant rewards or reminders to do my work.", "Requires high external motivation to complete tasks."],
            ["motivation", "I feel like no matter how hard I try, I won't succeed.", "Displays learned helplessness."],
            // Sensory
            ["sensory", "Bright lights in the classroom give me a headache.", "Complains about fluorescent or bright lights."],
            ["sensory", "Loud noises (like the school bell) startle or hurt me.", "Exaggerated startle response to loud noises."],
            ["sensory", "I hate the feeling of certain clothing tags or fabrics.", "Distracted or irritated by clothing textures."],
            ["sensory", "I seek out movement, like spinning or rocking.", "Engages in sensory-seeking behaviors (spinning/rocking)."],
            ["sensory", "I avoid messy activities like finger painting or clay.", "Tactile defensiveness (avoids getting hands messy)."],
            // Fine Motor
            ["fine_motor", "I struggle to tie my shoelaces or button my shirt.", "Difficulty with fasteners (buttons, laces)."],
            ["fine_motor", "I have a weird or awkward grip on my pencil.", "Atypical pencil grasp."],
            ["fine_motor", "I'm clumsy and often drop small objects.", "Frequently drops items or appears clumsy."],
            ["fine_motor", "I have trouble using scissors accurately.", "Poor scissor skills compared to peers."],
            ["fine_motor", "I avoid building blocks, Lego, or small puzzles.", "Avoids tasks requiring fine manual dexterity."],
            // Social
            ["social", "I don't understand when my friends are joking or being sarcastic.", "Takes literal meaning, misses sarcasm/jokes."],
            ["social", "I prefer to play alone rather than with classmates.", "Social isolates during group times."],
            ["social", "I stand too close to people when talking to them.", "Poor understanding of personal space."],
            ["social", "I have trouble taking turns in games or conversations.", "Monopolizes conversation or struggles sharing."],
            ["social", "I easily get into arguments with peers.", "Frequent peer conflicts."],
            // Communication
            ["communication", "I struggle to explain what happened in a story.", "Difficulty sequencing events in storytelling."],
            ["communication", "I use filler words like 'um' or 'stuff' a lot.", "Vague language use ('thingies', 'stuff')."],
            ["communication", "I have trouble understanding complex sentences.", "Misinterprets complex verbal phrasing."],
            ["communication", "My speech sounds younger than other kids my age.", "Immature articulation or sentence structure."],
            ["communication", "I avoid raising my hand because I can't formulate my answer in time.", "Hesitant to speak up due to expressive delay."]
        ];

        // Advanced Logic: Add 5 conditional/adaptive questions to reach 80
        const adaptiveQuestions = [
            { id: 76, cat: 'dyslexia', cond: 'dyslexia', student: "Does text sometimes blur when you read for more than 5 minutes?", teacher: "Does the student rub their eyes frequently after short reading stints?" },
            { id: 77, cat: 'attention', cond: 'attention', student: "Do you hyperfocus on things you like, but can't focus on schoolwork?", teacher: "Can the student focus intensely on preferred tasks, but not academics?" },
            { id: 78, cat: 'learning_anxiety', cond: 'learning_anxiety', student: "Have you ever faked being sick to avoid school?", teacher: "Does the student frequently visit the nurse without physical cause?" },
            { id: 79, cat: 'executive', cond: 'executive', student: "Do you forget to turn in homework even after you've finished it?", teacher: "Does the student complete work but fail to turn it in?" },
            { id: 80, cat: 'processing', cond: 'processing', student: "Do you feel smarter than your test scores show?", teacher: "Is there a significant gap between the student's verbal intelligence and written output?" }
        ];

        let questionBank = [];
        questionDataRaw.forEach((q, index) => {
            questionBank.push({
                id: index + 1,
                cat: q[0],
                student: q[1],
                teacher: q[2]
            });
        });

        // --- STATE ---
        let currentMode = 'student';
        let studentData = { name: '', age: '' };
        let activeQuestions = [];
        let currentIndex = 0;
        let answers = {}; // { cat_name: total_score }
        let categoryCounts = {}; // { cat_name: num_questions_asked }
        let answerLog = []; // track specific responses

        // --- UI FUNCTIONS ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        function toggleDyslexiaFont() {
            document.body.classList.toggle('dyslexia-font');
        }

        function switchSection(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // --- ASSESSMENT LOGIC ---
        function startAssessment() {
            const name = document.getElementById('student-name').value;
            const age = document.getElementById('student-age').value;
            
            if (!name || !age) {
                alert("Please enter name and age to proceed.");
                return;
            }

            studentData.name = name;
            studentData.age = age;
            currentMode = document.getElementById('assessment-mode').value;

            // Initialize tracking
            Object.keys(categories).forEach(cat => {
                answers[cat] = 0;
                categoryCounts[cat] = 0;
            });
            answerLog = [];
            
            // Randomize base questions slightly to prevent category fatigue, but keep some structure
            activeQuestions = [...questionBank].sort(() => Math.random() - 0.5);
            currentIndex = 0;

            switchSection('assessment-section');
            renderQuestion();
        }

        function renderQuestion() {
            if (currentIndex >= activeQuestions.length) {
                finishAssessment();
                return;
            }

            // Encouragement logic
            const msgBox = document.getElementById('encouragement-msg');
            if (currentIndex === 20) { msgBox.style.display = 'block'; msgBox.innerText = "Great job! You're 25% done."; setTimeout(()=>msgBox.style.display='none', 3000); }
            if (currentIndex === 40) { msgBox.style.display = 'block'; msgBox.innerText = "Halfway there! Keep it up."; setTimeout(()=>msgBox.style.display='none', 3000); }
            if (currentIndex === 60) { msgBox.style.display = 'block'; msgBox.innerText = "Almost done! Just a bit more."; setTimeout(()=>msgBox.style.display='none', 3000); }

            const q = activeQuestions[currentIndex];
            const qText = currentMode === 'student' ? q.student : q.teacher;
            
            document.getElementById('question-text').innerText = `${currentIndex + 1}. ${qText}`;
            
            const optionsContainer = document.getElementById('options-grid');
            optionsContainer.innerHTML = '';
            
            optionsTemplate.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt.text;
                btn.onclick = () => selectOption(btn, opt.val, q.cat);
                optionsContainer.appendChild(btn);
            });

            document.getElementById('next-btn').disabled = true;
            
            // Progress
            const progress = ((currentIndex) / activeQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').innerText = `Question ${currentIndex + 1} of ${activeQuestions.length}`;
        }

        let selectedValue = null;
        let selectedCategory = null;

        function selectOption(btn, val, cat) {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedValue = val;
            selectedCategory = cat;
            document.getElementById('next-btn').disabled = false;
        }

        function nextQuestion() {
            if (selectedValue !== null) {
                answers[selectedCategory] += selectedValue;
                categoryCounts[selectedCategory] += 1;
                answerLog.push({ id: activeQuestions[currentIndex].id, val: selectedValue });

                // Advanced Logic: Check conditions for adaptive questions
                if (selectedValue >= 2) { 
                    const adaptiveQ = adaptiveQuestions.find(aq => aq.cond === selectedCategory && !activeQuestions.includes(aq));
                    if (adaptiveQ) {
                        activeQuestions.splice(currentIndex + 2, 0, adaptiveQ); // Insert shortly after
                    }
                }

                selectedValue = null;
                currentIndex++;
                renderQuestion();
            }
        }

        function finishAssessment() {
            document.getElementById('progress-bar').style.width = '100%';
            setTimeout(() => {
                generateReport();
                switchSection('report-section');
            }, 500);
        }

        // --- REPORT & RESULTS LOGIC ---
        function getRiskLevel(score, maxScore) {
            const percentage = score / maxScore;
            if (percentage < 0.25) return { label: 'No Concern', class: 'risk-none' };
            if (percentage < 0.50) return { label: 'Mild Indicators', class: 'risk-mild' };
            if (percentage < 0.75) return { label: 'Moderate Indicators', class: 'risk-moderate' };
            return { label: 'Strong Indicators', class: 'risk-strong' };
        }

        function generateReport() {
            document.getElementById('rep-name').innerText = studentData.name;
            document.getElementById('rep-age').innerText = studentData.age;
            document.getElementById('rep-date').innerText = new Date().toLocaleDateString();
            document.getElementById('rep-mode').innerText = currentMode === 'student' ? 'Student Self-Report' : 'Teacher/Parent Observation';

            const grid = document.getElementById('result-grid');
            grid.innerHTML = '';

            let chartLabels = [];
            let chartData = [];
            let highestRisk = 0;
            let strengths = [];
            let recommendations = [];

            Object.keys(categories).forEach(cat => {
                const maxScore = categoryCounts[cat] * 3; // 3 is max weight
                const score = answers[cat];
                const risk = getRiskLevel(score, maxScore);
                const percentage = (score / maxScore) * 100;

                chartLabels.push(categories[cat].name);
                chartData.push(percentage);

                if (percentage < 25) strengths.push(categories[cat].name);
                if (percentage >= 50) recommendations.push(cat);
                if (percentage > highestRisk) highestRisk = percentage;

                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <h4>${categories[cat].name}</h4>
                    <p style="font-size: 0.85rem; margin-bottom: 5px;">${categories[cat].desc}</p>
                    <span class="risk-badge ${risk.class}">${risk.label}</span>
                `;
                grid.appendChild(card);
            });

            drawChart(chartLabels, chartData);
            populateTextAnalysis(strengths, recommendations, highestRisk);
        }

        function populateTextAnalysis(strengths, recKeys, highestRisk) {
            const sList = document.getElementById('strengths-list');
            sList.innerHTML = strengths.length > 0 
                ? strengths.map(s => `<li>Shows standard development or resilience in <strong>${s}</strong>.</li>`).join('')
                : `<li>Student shows a complex profile. Focus on building self-esteem during challenges.</li>`;

            const rList = document.getElementById('recommendations-list');
            const recMap = {
                dyslexia: "Use audiobooks, allow extra time for reading, and utilize text-to-speech tools.",
                dyscalculia: "Provide physical manipulatives for math, allow calculators, use graph paper.",
                dysgraphia: "Allow typing instead of writing, provide print outlines, reduce copying from board.",
                attention: "Use preferential seating, break tasks into 10-minute chunks, provide silent fidgets.",
                executive: "Implement visual schedules, color-coded folders, and explicitly teach planning.",
                processing: "Reduce workload volume (not complexity), provide extra time, don't cold-call.",
                working_memory: "Provide written instructions alongside verbal ones, allow memory aids (formulas).",
                recall: "Use mnemonic devices, spaced repetition, and prefer multiple-choice formats.",
                learning_anxiety: "Praise effort over grades, create a safe space for mistakes.",
                test_anxiety: "Teach deep breathing, allow testing in a quiet room, consider alternative assessments.",
                motivation: "Connect learning to personal interests, provide frequent positive reinforcement.",
                sensory: "Allow noise-canceling headphones, natural lighting, and movement breaks.",
                fine_motor: "Provide pencil grips, thick markers, and occupational therapy exercises.",
                social: "Facilitate structured small group work, role-play social scenarios.",
                communication: "Give wait time (10 seconds) for responses, don't interrupt."
            };

            rList.innerHTML = recKeys.length > 0
                ? recKeys.map(k => `<li><strong>${categories[k].name}:</strong> ${recMap[k]}</li>`).join('')
                : `<li>No significant interventions required currently. Continue standard support.</li>`;

            const profNote = document.getElementById('professional-note');
            if (highestRisk >= 75) {
                profNote.innerHTML = "Based on the <strong>Strong Indicators</strong> present, a comprehensive evaluation by an Educational Psychologist, Pediatrician, or relevant specialist is highly recommended. Share this screening report with them as a baseline.";
            } else if (highestRisk >= 50) {
                profNote.innerHTML = "Moderate indicators are present. Implement the suggested accommodations in class/home and monitor progress for 8-12 weeks. If struggles persist, consider formal evaluation.";
            } else {
                profNote.innerHTML = "Results indicate standard academic development. Continue universal design for learning practices and standard monitoring.";
            }
        }

        // --- PURE JS CANVAS CHART ---
        function drawChart(labels, data) {
            const canvas = document.getElementById('resultsChart');
            const ctx = canvas.getContext('2d');
            
            // Handle high DPI displays
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = 300 * dpr;
            ctx.scale(dpr, dpr);
            
            const w = rect.width;
            const h = 300;
            const padding = 40;
            const bottomPadding = 100; // Space for angled text

            ctx.clearRect(0, 0, w, h);

            // Draw Y Axis
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, h - bottomPadding);
            ctx.lineTo(w - padding, h - bottomPadding);
            ctx.strokeStyle = '#94a3b8';
            ctx.stroke();

            // Draw horizontal grid lines (0, 25, 50, 75, 100)
            ctx.fillStyle = '#64748b';
            ctx.font = '10px system-ui';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const y = h - bottomPadding - (i * ((h - padding - bottomPadding) / 4));
                ctx.fillText(i * 25 + '%', padding - 5, y + 4);
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(w - padding, y);
                ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
                ctx.stroke();
            }

            // Draw Bars
            const barWidth = ((w - (padding * 2)) / data.length) * 0.7;
            const spacing = ((w - (padding * 2)) / data.length);

            data.forEach((val, i) => {
                const x = padding + (i * spacing) + (spacing * 0.15);
                const barHeight = (val / 100) * (h - padding - bottomPadding);
                const y = h - bottomPadding - barHeight;

                // Color based on risk
                if (val < 25) ctx.fillStyle = '#10b981';
                else if (val < 50) ctx.fillStyle = '#3b82f6';
                else if (val < 75) ctx.fillStyle = '#f59e0b';
                else ctx.fillStyle = '#ef4444';

                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw rotated labels
                ctx.save();
                ctx.translate(x + (barWidth / 2), h - bottomPadding + 10);
                ctx.rotate(-Math.PI / 4);
                ctx.textAlign = 'right';
                ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#f1f5f9' : '#1e293b';
                ctx.font = '10px system-ui';
                ctx.fillText(labels[i], 0, 0);
                ctx.restore();
            });
        }
        
        // Handle window resize for chart
        window.addEventListener('resize', () => {
            if (document.getElementById('report-section').classList.contains('active')) {
                generateReport(); // Redraws chart
            }
        });

    // 1. Dynamic Manifest Generation (Single File logic)
const manifest = {
    "name": "EduScreen JNV Saran",
    "short_name": "EduScreen",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#0f172a",
    "theme_color": "#bf953f",
    "icons": [
        {
            "src": "https://cdn-icons-png.flaticon.com/512/2940/2940651.png",
            "sizes": "512x512",
            "type": "image/png"
        }
    ]
};
const manifestStr = JSON.stringify(manifest);
const blob = new Blob([manifestStr], {type: 'application/json'});
document.getElementById('pwa-manifest').setAttribute('href', URL.createObjectURL(blob));

// 2. Service Worker Inline Script
const swCode = `
const CACHE_NAME = 'eduscreen-cache-v1';
const URLS_TO_CACHE = [window.location.href];

self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME).then((cache) => cache.addAll(URLS_TO_CACHE))
    );
});

self.addEventListener('fetch', (event) => {
    event.respondWith(
        caches.match(event.request).then((response) => {
            return response || fetch(event.request);
        })
    );
});
`;

// 3. Registering the Service Worker
if ('serviceWorker' in navigator) {
    const swBlob = new Blob([swCode], {type: 'text/javascript'});
    const swUrl = URL.createObjectURL(swBlob);
    
    navigator.serviceWorker.register(swUrl).then(() => {
        console.log('PWA: Ready for offline use');
    }).catch(err => console.log('PWA Error:', err));
}

    
    </script>
</body>
</html>
